#! /etc/bqckup/venv/bin/python3

import typer, getpass
from classes.bqckup import Bqckup
from classes.config import Config
from classes.server import Server

bq_cli = typer.Typer()

# @bq_cli.command()
# def check_update():
#     pass

# @bq_cli.command()
#     def version():
#         pass

@bq_cli.command()
def test_config():
    Bqckup().validate_config('ojtPlugin')

@bq_cli.command()
def run(force:bool = False):
    Bqckup().backup(force=force)
    
@bq_cli.command()
def gui_active():
    from gevent.pywsgi import WSGIServer
    try:        
        port = int(Config().read('web', 'port'))
        http_server = WSGIServer(('0.0.0.0', port), app)
        print(f"\nListening to http://{Server().ip()}:{port}\n", flush=True)
        http_server.serve_forever()
    except Exception as e:
        print(f"Failed to start web server, {str(e)}")
        
    
    
if __name__ == "__main__":
    if getpass.getuser() != 'root':
        print("Please run this script as root user")
    else:
        from app import app, initialization
        try:
            initialization()
        except Exception as e:
            print(f"Failed to initialize, {str(e)}")
        else:
            bq_cli()
